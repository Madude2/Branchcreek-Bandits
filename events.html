<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Begivenheder - Branchcreek Bandits</title>

<!-- Tailwind + Fonts + Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.cdnfonts.com/css/western" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

<style>
.nav-link { color: white; }
.nav-link:hover { color: #d4a017; }
h1,h2,h3,h4,h5,h6 { font-family: 'Western', sans-serif; }
.western-text { font-family: 'Western', sans-serif; }
.btn-gold { background-color: #d4a017; transition: all 0.3s ease; }
.btn-gold:hover { background-color: #b78a14; transform: translateY(-2px); }
</style>
</head>

<body class="bg-gray-100 font-sans flex flex-col min-h-screen">

<!-- Navbar -->
<div id="navbar"></div>

<!-- Main Content -->
<div class="flex-grow">
  <section class="py-16">
    <div class="container mx-auto px-6">
      <h1 class="western-text text-5xl mb-6 text-center">Begivenheder</h1>
      <p class="text-gray-700 mb-4 text-center">
        Her vil du finde kommende skydninger, turneringer og sociale arrangementer.
      </p>

      <!-- Admin: Create Event Button -->
      <div id="admin-create-btn" class="flex justify-center mb-6 hidden">
        <button id="open-create-popup" class="btn-gold text-white px-4 py-2 rounded-lg font-bold text-lg">
          + Opret Nyt Event
        </button>
      </div>

      <!-- Event Cards -->
      <div id="events-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
  </section>
</div>

<!-- Create Event Popup -->
<div id="create-popup" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg w-80 relative">
    <h2 class="western-text text-2xl mb-4">Opret Nyt Event</h2>
    <input type="text" id="event-title" placeholder="Titel" class="w-full mb-2 px-3 py-2 border rounded">
    <input type="date" id="event-date" class="w-full mb-2 px-3 py-2 border rounded">
    <input type="text" id="event-location" placeholder="Sted" class="w-full mb-2 px-3 py-2 border rounded">
    <textarea id="event-description" placeholder="Beskrivelse" class="w-full mb-2 px-3 py-2 border rounded"></textarea>
    <div class="flex justify-end gap-2 mt-4">
      <button id="close-popup" class="px-4 py-2 border rounded">Annuller</button>
      <button id="save-event" class="btn-gold text-white px-4 py-2 rounded-lg">Gem Event</button>
    </div>
  </div>
</div>

<!-- Footer -->
<div id="footer"></div>

<!-- -------- includeHTML helper -------- -->
<script>
async function includeHTML(file, elementId, callback){
  try {
    const res = await fetch(file);
    const html = await res.text();
    const mount = document.getElementById(elementId);
    mount.innerHTML = html;

    // Re-run scripts in injected HTML
    const scripts = mount.querySelectorAll("script");
    for (const oldScript of scripts) {
      const s = document.createElement("script");
      for (const attr of oldScript.attributes) s.setAttribute(attr.name, attr.value);
      if (!oldScript.src) s.textContent = oldScript.textContent;
      document.body.appendChild(s);
    }

    if (window.feather) feather.replace();
    if (callback) callback();
  } catch (err) {
    console.error("includeHTML error:", err);
  }
}
</script>

<!-- -------- Load Navbar + Footer -------- -->
<script>
includeHTML("nav.html", "navbar", () => {
  if (typeof setupAuth === "function") setupAuth();

  // Menu toggles
  const menuBtn=document.getElementById('menu-btn');
  const mobileMenu=document.getElementById('mobile-menu');
  if(menuBtn && mobileMenu) menuBtn.addEventListener('click',()=>mobileMenu.classList.toggle('hidden'));

  const loginBtn=document.getElementById('login-btn');
  const loginDropdown=document.getElementById('login-dropdown');
  if(loginBtn && loginDropdown) loginBtn.addEventListener('click',()=>loginDropdown.classList.toggle('hidden'));

  const mobileLoginBtn=document.getElementById('mobile-login-btn');
  const mobileLoginForm=document.getElementById('mobile-login-form');
  if(mobileLoginBtn && mobileLoginForm) mobileLoginBtn.addEventListener('click',()=>mobileLoginForm.classList.toggle('hidden'));

  // üîî Refresh notifications after navbar loads
  setTimeout(() => {
    if (typeof window.refreshNotificationsBadge === "function") {
      window.refreshNotificationsBadge();
    }
  }, 1200);
});

includeHTML("footer.html", "footer");
</script>

<!-- ‚úÖ Shared Scripts FIRST -->
<script type="module" src="js/firebase.js"></script>
<script type="module" src="js/auth.js"></script>
<script type="module" src="js/common.js"></script>

<!-- ‚úÖ Page-Specific Event Logic (AFTER shared scripts) -->
<script type="module">
import { db, auth } from "./js/firebase.js";
import { 
  collection, addDoc, getDocs, deleteDoc, doc 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const ADMIN_EMAIL = "asbjrnahle33@gmail.com";
const eventsContainer = document.getElementById("events-container");

/* ---------- Load Events ---------- */
async function loadEvents(){
  if(!eventsContainer) return;
  eventsContainer.innerHTML = "";
  try {
    const snapshot = await getDocs(collection(db,"events"));
    if(snapshot.empty){
      eventsContainer.innerHTML = `<p class="text-center text-gray-500">Ingen events tilg√¶ngelige.</p>`;
      return;
    }

    snapshot.forEach(docSnap => {
      const e = docSnap.data();
      const eventEl = document.createElement("div");
      eventEl.className = "p-4 bg-white rounded shadow relative";

      const formattedDate = e.date ? new Date(e.date).toLocaleDateString("da-DK",{day:'numeric', month:'long', year:'numeric'}) : "";
      eventEl.innerHTML = `<h3 class="font-bold text-lg">${e.title}</h3>
                           <p class="text-sm text-gray-600">${formattedDate} - ${e.location}</p>
                           <p>${e.description || ""}</p>`;

      onAuthStateChanged(auth, user => {
        if(user && user.email === ADMIN_EMAIL){
          const delBtn = document.createElement("button");
          delBtn.innerHTML = `<i data-feather="x-circle" class="text-red-500"></i>`;
          delBtn.className = "absolute top-2 right-2";
          delBtn.onclick = async () => {
            if(confirm("Er du sikker p√• du vil slette dette event?")){
              await deleteDoc(doc(db,"events",docSnap.id));
              loadEvents();
            }
          };
          eventEl.appendChild(delBtn);
          feather.replace();
        }
      });

      eventsContainer.appendChild(eventEl);
    });
  } catch(err){
    console.error("Error loading events:", err);
    eventsContainer.innerHTML = `<p class="text-center text-red-500">Fejl ved indl√¶sning af events</p>`;
  }
}
window.addEventListener('DOMContentLoaded', () => {
  // Vent 1 sekund for at v√¶re sikker p√• at Firebase + Auth er klar
  setTimeout(() => loadEvents(), 1000);
});


/* ---------- Create Event + Notification ---------- */
const createPopup = document.getElementById("create-popup");
document.getElementById("open-create-popup")?.addEventListener("click", () => {
  createPopup.classList.remove("hidden");
  createPopup.classList.add("flex");
});
document.getElementById("close-popup")?.addEventListener("click", () => {
  createPopup.classList.add("hidden");
  createPopup.classList.remove("flex");
});

document.getElementById("save-event")?.addEventListener("click", async () => {
  const title = document.getElementById("event-title").value.trim();
  const date = document.getElementById("event-date").value;
  const location = document.getElementById("event-location").value.trim();
  const description = document.getElementById("event-description").value.trim();
  const user = auth.currentUser;

  if(!user || user.email !== ADMIN_EMAIL){
    alert("Kun admin kan oprette events");
    return;
  }

  if(!title || !date || !location){
    alert("Udfyld alle felter!");
    return;
  }

  try {
    // Create event
    await addDoc(collection(db,"events"), { title, date, location, description, createdAt: new Date() });

    // üîî Create notification
    const formattedDate = new Date(date).toLocaleDateString('da-DK', { day: '2-digit', month: 'long', year: 'numeric' });
    const message = `Nyt event oprettet: ${title} - ${formattedDate}`;
    await addDoc(collection(db, "notifications"), {
      title: "Nyt Event!",
      message,
      timestamp: new Date()
    });

    createPopup.classList.add("hidden");
    createPopup.classList.remove("flex");
    document.getElementById("event-title").value = "";
    document.getElementById("event-date").value = "";
    document.getElementById("event-location").value = "";
    document.getElementById("event-description").value = "";
    loadEvents();

    alert("Event oprettet, og notifikation sendt!");
  } catch (error) {
    console.error("Fejl ved oprettelse:", error);
    alert("Fejl ved oprettelse: " + error.message);
  }
});

/* ---------- Admin button visibility ---------- */
onAuthStateChanged(auth, user => {
  const adminBtn = document.getElementById("admin-create-btn");
  if (user && user.email === ADMIN_EMAIL) adminBtn.classList.remove("hidden");
  else adminBtn.classList.add("hidden");
});
</script>

</body>
</html>
