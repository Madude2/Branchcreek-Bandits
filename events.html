<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Begivenheder - Branchcreek Bandits</title>

<!-- Tailwind + Fonts + Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.cdnfonts.com/css/western" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

<style>
.nav-link { color: white; }
.nav-link:hover { color: #d4a017; }
h1,h2,h3,h4,h5,h6 { font-family: 'Western', sans-serif; }
.western-text { font-family: 'Western', sans-serif; }
.btn-gold { background-color: #d4a017; transition: all 0.3s ease; }
.btn-gold:hover { background-color: #b78a14; transform: translateY(-2px); }
</style>
</head>
<body class="bg-gray-100 font-sans flex flex-col min-h-screen">

<!-- Navbar -->
<div id="navbar"></div>

<!-- Main Content -->
<div class="flex-grow">
  <section class="py-16">
    <div class="container mx-auto px-6">
      <h1 class="western-text text-5xl mb-6 text-center">Begivenheder</h1>
      <p class="text-gray-700 mb-4 text-center">Her vil du finde kommende skydninger, turneringer og sociale arrangementer.</p>

      <!-- Admin: Create Event Button -->
      <div id="admin-create-btn" class="flex justify-center mb-6 hidden">
        <button id="open-create-popup" class="btn-gold text-white px-4 py-2 rounded-lg font-bold text-lg">+ Opret Nyt Event</button>
      </div>

      <!-- Event Cards -->
      <div id="events-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
  </section>
</div>

<!-- Create Event Popup -->
<div id="create-popup" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg w-80 relative">
    <h2 class="western-text text-2xl mb-4">Opret Nyt Event</h2>
    <input type="text" id="event-title" placeholder="Titel" class="w-full mb-2 px-3 py-2 border rounded">
    <input type="date" id="event-date" class="w-full mb-2 px-3 py-2 border rounded">
    <input type="text" id="event-location" placeholder="Sted" class="w-full mb-2 px-3 py-2 border rounded">
    <textarea id="event-description" placeholder="Beskrivelse" class="w-full mb-2 px-3 py-2 border rounded"></textarea>
    <div class="flex justify-end gap-2 mt-4">
      <button id="close-popup" class="px-4 py-2 border rounded">Annuller</button>
      <button id="save-event" class="btn-gold text-white px-4 py-2 rounded-lg">Gem Event</button>
    </div>
  </div>
</div>

<!-- Footer -->
<div id="footer"></div>

<!-- Firebase Scripts -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

// ---------------------
// Firebase Config
// ---------------------
const firebaseConfig = {
  apiKey: "AIzaSyCzk3xKdC0p9logWjGIZX41M1oeIeqjxGI",
  authDomain: "branchcreek-bandits.firebaseapp.com",
  projectId: "branchcreek-bandits",
  storageBucket: "branchcreek-bandits.firebasestorage.app",
  messagingSenderId: "828305260971",
  appId: "1:828305260971:web:6c3601fc97601a9621d2ee",
  measurementId: "G-550TRD5SQ3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_EMAIL = "asbjrnahle33@gmail.com";

// ---------------------
// Navbar & Footer Loader
// ---------------------
function includeHTML(file, elementId, callback){
  fetch(file).then(res => res.text()).then(data => {
    document.getElementById(elementId).innerHTML = data;
    if(callback) callback();
    feather.replace();
  }).catch(console.error);
}

// Load navbar and footer, then init login buttons
includeHTML("nav.html","navbar", initLogin);
includeHTML("footer.html","footer");

// ---------------------
// Login Functions
// ---------------------
function initLogin(){
  const loginBtn = document.getElementById("login-btn");
  const loginDropdown = document.getElementById("login-dropdown");
  const mobileLoginBtn = document.getElementById("mobile-login-btn");
  const mobileLoginForm = document.querySelector('#mobile-login-form div');

  const arrowSVG = `<svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>`;

  function showLogin(user){
    if(user){
      const name = user.displayName || user.email;
      if(loginBtn) loginBtn.innerHTML = `${name} ${arrowSVG} <button onclick="logout()" class="ml-2 text-red-500 font-bold">Log ud</button>`;
      if(mobileLoginBtn) mobileLoginBtn.innerHTML = `${name} <button onclick="logout()" class="ml-2 text-red-500 font-bold">Log ud</button>`;
      const adminBtn = document.getElementById("admin-create-btn");
      if(user.email === ADMIN_EMAIL && adminBtn) adminBtn.classList.remove("hidden");
    } else {
      if(loginBtn) loginBtn.innerHTML = `Login ${arrowSVG}`;
      if(mobileLoginBtn) mobileLoginBtn.innerHTML = "Login";
      const adminBtn = document.getElementById("admin-create-btn");
      if(adminBtn) adminBtn.classList.add("hidden");
    }
  }

  onAuthStateChanged(auth, user => showLogin(user));

  if(loginBtn) loginBtn.addEventListener('click', () => loginDropdown.classList.toggle('hidden'));
  if(mobileLoginBtn) mobileLoginBtn.addEventListener('click', () => mobileLoginForm.classList.toggle('hidden'));
}

// ---------------------
// Login / Logout Functions
// ---------------------
window.login = () => {
  const email = document.getElementById("login-email").value;
  const password = document.getElementById("login-password").value;
  signInWithEmailAndPassword(auth,email,password)
    .then(userCredential => {
      document.getElementById("login-dropdown").classList.add("hidden");
      loadEvents(); // reload events to show admin buttons
    })
    .catch(err => alert(err.message));
};

window.mobileLogin = () => {
  const email = document.getElementById("mobile-login-email").value;
  const password = document.getElementById("mobile-login-password").value;
  signInWithEmailAndPassword(auth,email,password)
    .then(userCredential => {
      document.querySelector('#mobile-login-form div').classList.add("hidden");
      loadEvents(); // reload events to show admin buttons
    })
    .catch(err => alert(err.message));
};

window.logout = () => {
  signOut(auth).then(()=> location.reload()).catch(err=>alert(err.message));
};

// ---------------------
// Event Functions
// ---------------------
const eventsContainer = document.getElementById("events-container");
async function loadEvents(){
  if(!eventsContainer) return;
  eventsContainer.innerHTML = "";
  try {
    const snapshot = await getDocs(collection(db,"events"));
    if(snapshot.empty){
      eventsContainer.innerHTML = `<p class="text-center text-gray-500">Ingen events tilgængelige.</p>`;
      return;
    }

    snapshot.forEach(docSnap => {
      const e = docSnap.data();
      const eventEl = document.createElement("div");
      eventEl.className = "p-4 bg-white rounded shadow relative";

      const formattedDate = e.date ? new Date(e.date).toLocaleDateString("da-DK",{day:'numeric', month:'long', year:'numeric'}) : "";
      eventEl.innerHTML = `<h3 class="font-bold text-lg">${e.title}</h3>
                           <p class="text-sm text-gray-600">${formattedDate} - ${e.location}</p>
                           <p>${e.description || ""}</p>`;

      // Admin delete button: vises efter login-status
      onAuthStateChanged(auth, user => {
        if(user && user.email === ADMIN_EMAIL){
          const delBtn = document.createElement("button");
          delBtn.innerHTML = `<i data-feather="x-circle" class="text-red-500"></i>`;
          delBtn.className = "absolute top-2 right-2";
          delBtn.onclick = async () => {
            if(confirm("Er du sikker på du vil slette dette event?")){
              await deleteDoc(doc(db,"events",docSnap.id));
              loadEvents();
            }
          };
          eventEl.appendChild(delBtn);
          feather.replace();
        }
      });

      eventsContainer.appendChild(eventEl);
    });
  } catch(err){
    console.error("Error loading events:", err);
    eventsContainer.innerHTML = `<p class="text-center text-red-500">Fejl ved indlæsning af events</p>`;
  }
}
window.addEventListener('DOMContentLoaded', loadEvents);

// ---------------------
// Create Event Popup
// ---------------------
const createPopup = document.getElementById("create-popup");
document.getElementById("open-create-popup")?.addEventListener("click", () => {
  createPopup.classList.remove("hidden");
  createPopup.classList.add("flex");
});
document.getElementById("close-popup")?.addEventListener("click", () => {
  createPopup.classList.add("hidden");
  createPopup.classList.remove("flex");
});

document.getElementById("save-event")?.addEventListener("click", async () => {
  const title = document.getElementById("event-title").value.trim();
  const date = document.getElementById("event-date").value;
  const location = document.getElementById("event-location").value.trim();
  const description = document.getElementById("event-description").value.trim();
  const user = auth.currentUser;

  if(!user || user.email !== ADMIN_EMAIL){
    alert("Kun admin kan oprette events");
    return;
  }

  if(!title || !date || !location){
    alert("Udfyld alle felter!");
    return;
  }

  await addDoc(collection(db,"events"), { title, date, location, description, createdAt: new Date() });
  createPopup.classList.add("hidden");
  createPopup.classList.remove("flex");
  document.getElementById("event-title").value = "";
  document.getElementById("event-date").value = "";
  document.getElementById("event-location").value = "";
  document.getElementById("event-description").value = "";
  loadEvents();
});

// ---------------------
// Mobile Menu Toggle
// ---------------------
document.addEventListener('DOMContentLoaded', () => {
  const menuBtn = document.getElementById('menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  menuBtn?.addEventListener('click',()=> mobileMenu?.classList.toggle('hidden'));
});
</script>
</body>
</html>
