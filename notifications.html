<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifikationer - Branchcreek Bandits</title>

  <!-- Tailwind + Fonts + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.cdnfonts.com/css/western" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <style>
    .nav-link { color: white; }
    .nav-link:hover { color: #d4a017; }
    h1,h2,h3,h4,h5,h6 { font-family: 'Western', sans-serif; }
    .western-text { font-family: 'Western', sans-serif; }
    .btn { padding: 6px 12px; border-radius: 6px; font-weight: bold; transition: all 0.2s; }
    .btn-approve { background-color: #16a34a; color: white; }
    .btn-approve:hover { background-color: #15803d; }
    .btn-deny { background-color: #dc2626; color: white; }
    .btn-deny:hover { background-color: #b91c1c; }
    #notif-count { display: none !important; } /* prevent flicker */
  </style>
</head>

<body class="bg-gray-100 font-sans flex flex-col min-h-screen">

  <!-- Dynamic Navbar -->
  <div id="navbar"></div>

  <!-- Main Content -->
  <main class="flex-grow py-16">
    <div class="container mx-auto px-6">
      <h1 class="western-text text-5xl mb-6 text-center text-gray-900">Notifikationer</h1>
      <p class="text-gray-700 mb-10 text-center">
        Her kan du se de seneste opdateringer fra Branchcreek Bandits.
      </p>

      <div id="notifications-container" class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
        <p class="text-gray-500 text-center">Indl√¶ser notifikationer...</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Shared Scripts -->
  <script type="module" src="js/auth.js"></script>
  <script type="module" src="main.js"></script>
  <script type="module" src="js/common.js"></script>

  <!-- Page Logic -->
  <script type="module">
    import { getApps, initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, orderBy, limit,
      updateDoc, doc, arrayUnion, addDoc, deleteDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzk3xKdC0p9logWjGIZX41M1oeIeqjxGI",
      authDomain: "branchcreek-bandits.firebaseapp.com",
      projectId: "branchcreek-bandits",
      storageBucket: "branchcreek-bandits.firebasestorage.app",
      messagingSenderId: "828305260971",
      appId: "1:828305260971:web:6c3601fc97601a9621d2ee",
      measurementId: "G-550TRD5SQ3"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const container = document.getElementById("notifications-container");
    const ADMIN_EMAIL = "asbjrnahle33@gmail.com";

    /* ---------- Load Notifications ---------- */
   async function loadNotifications(user) {
  try {
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    const userData = userSnap.exists() ? userSnap.data() : {};
    const isAdmin = user.email === ADMIN_EMAIL;

    // ‚úÖ Improved verification detection
    const isVerified =
      isAdmin ||
      userData?.verifiedByAdmin === true ||
      userData?.status === "verified" ||
      userData?.role === "verified" ||
      user?.role === "verified";

    console.log("[notifications] UserData:", userData);
    console.log("[notifications] verifiedByAdmin:", userData?.verifiedByAdmin);
    console.log("[notifications] role:", userData?.role);
    console.log("[notifications] isVerified computed:", isVerified);

    // üö´ Prevent unverified access
    if (!isVerified) {
      container.innerHTML = `<p class="text-red-500 text-center py-8">
        Du skal v√¶re godkendt af en administrator for at se notifikationer.
      </p>`;
      return;
    }

    // --- rest of your code below unchanged ---


        const qy = query(collection(db, "notifications"), orderBy("timestamp", "desc"), limit(50));
        const snap = await getDocs(qy);

        if (snap.empty) {
          container.innerHTML = `<p class="text-gray-500 text-center py-8">Ingen notifikationer endnu.</p>`;
          return;
        }

        container.innerHTML = "";
        let pendingApprovals = 0;

        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          const id = docSnap.id;

          const isApproval = data.type === "approval_request";
          const isOwner = data.userId && data.userId === user.uid;

          // üîí Visibility rules:
          // - Admin: sees everything
          // - Verified users: all except other users‚Äô approval requests
          // - Regular users: only their own
          if (!isAdmin) {
            if (isApproval && !isOwner) continue;
          }

          const time = data.timestamp
            ? new Date((data.timestamp.seconds || 0) * 1000).toLocaleString("da-DK")
            : "";

          const notif = document.createElement("div");
          notif.className = "border-b border-gray-200 py-3 last:border-none";

          let html = `
            <div class="font-bold text-yellow-700 text-lg mb-1">${data.title || "Ny Notifikation"}</div>
            <div class="text-gray-700 mb-1">${data.message || ""}</div>
            <div class="text-gray-500 text-sm">${time}</div>
          `;

          if (isAdmin && isApproval) {
            pendingApprovals++;
            html += `
              <div class="flex gap-3 mt-3">
                <button class="btn btn-approve" id="approve-${id}">Godkend</button>
                <button class="btn btn-deny" id="deny-${id}">Afvis</button>
              </div>
            `;
          }

          notif.innerHTML = html;
          container.appendChild(notif);

          if (isAdmin && isApproval) {
            document.getElementById(`approve-${id}`)?.addEventListener("click", () => handleApproval(data.userId, id, true));
            document.getElementById(`deny-${id}`)?.addEventListener("click", () => handleApproval(data.userId, id, false));
          }
        }

        console.log(`[notifications] ‚úÖ Indl√¶st (${pendingApprovals} godkendelser afventer).`);
      } catch (err) {
        console.error("‚ùå Fejl ved indl√¶sning af notifikationer:", err);
        if (err.code?.includes("permission-denied")) {
          container.innerHTML = `<p class="text-red-500 text-center py-8">
            Du har ikke adgang til disse notifikationer.
          </p>`;
        } else {
          container.innerHTML = `<p class="text-red-500 text-center py-8">
            Fejl ved indl√¶sning af notifikationer
          </p>`;
        }
      }
    }

    /* ---------- Handle Admin Approval ---------- */
    async function handleApproval(userId, notifId, approve) {
      try {
        const userRef = doc(db, "users", userId);
        const notifRef = doc(db, "notifications", notifId);

        if (approve) {
          await updateDoc(userRef, { verifiedByAdmin: true, status: "verified", role: "verified" });
          
          
          await addDoc(collection(db, "notifications"), {
            title: "Konto godkendt",
            message: "‚úÖ Din konto er nu godkendt af en administrator.",
            type: "user_update",
            userId,
            timestamp: new Date(),
            readBy: [],
          });
        } else {
          await updateDoc(userRef, { verifiedByAdmin: false, status: "denied" });
          await new Promise(r => setTimeout(r, 1000)); // wait a second for Firestore to propagate
          await addDoc(collection(db, "notifications"), {
            title: "Konto afvist",
            message: "‚ùå Din anmodning om godkendelse blev afvist.",
            type: "user_update",
            userId,
            timestamp: new Date(),
            readBy: [],
          });
        }

        await deleteDoc(notifRef);
        alert(approve ? "‚úÖ Bruger godkendt!" : "‚ùå Bruger afvist!");
        await loadNotifications(auth.currentUser);
      } catch (err) {
        console.error("‚ùå Fejl ved godkendelse:", err);
        alert("Der opstod en fejl. Pr√∏v igen.");
      }
    }

    /* ---------- Mark All as Read ---------- */
    async function markAllAsRead(user) {
      try {
        const qy = query(collection(db, "notifications"), orderBy("timestamp", "desc"));
        const snap = await getDocs(qy);
        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          const readBy = Array.isArray(data.readBy) ? data.readBy : [];
          if (!readBy.includes(user.uid)) {
            await updateDoc(doc(db, "notifications", docSnap.id), {
              readBy: arrayUnion(user.uid)
            });
          }
        }
      } catch (err) {
        console.error("‚ö†Ô∏è Fejl ved markering som l√¶st:", err);
      }
    }

    /* ---------- Init ---------- */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        container.innerHTML = `<p class="text-gray-500 text-center py-8">
          Log ind for at se notifikationer.
        </p>`;
        return;
      }
      await loadNotifications(user);
      if (user.emailVerified) await markAllAsRead(user);
    });
  </script>
</body>
</html>
