<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifikationer - Branchcreek Bandits</title>

  <!-- Tailwind + Fonts + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.cdnfonts.com/css/western" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <style>
    .nav-link { color: white; }
    .nav-link:hover { color: #d4a017; }
    h1,h2,h3,h4,h5,h6 { font-family: 'Western', sans-serif; }
    .western-text { font-family: 'Western', sans-serif; }
    .btn { padding: 6px 12px; border-radius: 6px; font-weight: bold; transition: all 0.2s; }
    .btn-approve { background-color: #16a34a; color: white; }
    .btn-approve:hover { background-color: #15803d; }
    .btn-deny { background-color: #dc2626; color: white; }
    .btn-deny:hover { background-color: #b91c1c; }
    #notif-count { display: none !important; } /* prevent flicker */
  </style>
</head>

<body class="bg-gray-100 font-sans flex flex-col min-h-screen">

  <!-- Dynamic Navbar -->
  <div id="navbar"></div>

  <!-- Main Content -->
  <main class="flex-grow py-16">
    <div class="container mx-auto px-6">
      <h1 class="western-text text-5xl mb-6 text-center text-gray-900">Notifikationer</h1>
      <p class="text-gray-700 mb-10 text-center">
        Her kan du se de seneste opdateringer fra Branchcreek Bandits.
      </p>

      <div id="notifications-container" class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
        <p class="text-gray-500 text-center">Indl√¶ser notifikationer...</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Shared Scripts -->
  <script type="module" src="js/auth.js"></script>
  <script type="module" src="main.js"></script>
  <script type="module" src="js/common.js"></script>

  <!-- Page Logic -->
  <script type="module">
    import { getApps, initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, orderBy, limit,
      updateDoc, doc, arrayUnion, addDoc, deleteDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { sendUserNotification, sendAdminNotification } from "./js/common.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzk3xKdC0p9logWjGIZX41M1oeIeqjxGI",
      authDomain: "branchcreek-bandits.firebaseapp.com",
      projectId: "branchcreek-bandits",
      storageBucket: "branchcreek-bandits.appspot.com",
      messagingSenderId: "828305260971",
      appId: "1:828305260971:web:6c3601fc97601a9621d2ee",
      measurementId: "G-550TRD5SQ3"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const container = document.getElementById("notifications-container");
    const ADMIN_EMAIL = "asbjrnahle33@gmail.com";

    /* ---------- üü¢ APPROVE USER ---------- */
    async function approveUser(userId) {
      const admin = auth.currentUser;
      const adminUid = admin.uid;

      // Fetch user info for display
      const userSnap = await getDoc(doc(db, "users", userId));
      const userData = userSnap.exists() ? userSnap.data() : {};
      const userName = userData.displayName || userData.name || userData.email || "ukendt bruger";

      await updateDoc(doc(db, "users", userId), {
        verifiedByAdmin: true,
        status: "verified",
        role: "verified"
      });

      await sendUserNotification(
        userId,
        "Konto godkendt",
        "‚úÖ Din konto er nu godkendt af en administrator.",
        "approval_approved"
      );

      await sendAdminNotification(
        adminUid,
        "Bruger godkendt",
        `har godkendt brugeren ${userName}.`,
        "admin_action"
      );
    }

    /* ---------- üî¥ DENY USER ---------- */
    async function denyUser(userId) {
      const admin = auth.currentUser;
      const adminUid = admin.uid;

      const userSnap = await getDoc(doc(db, "users", userId));
      const userData = userSnap.exists() ? userSnap.data() : {};
      const userName = userData.displayName || userData.name || userData.email || "ukendt bruger";

      await updateDoc(doc(db, "users", userId), {
        verifiedByAdmin: false,
        status: "denied"
      });

      await sendUserNotification(
        userId,
        "Konto afvist",
        "‚ùå Din anmodning om godkendelse blev afvist.",
        "approval_denied"
      );

      await sendAdminNotification(
        adminUid,
        "Bruger afvist",
        `har afvist brugeren ${userName}.`,
        "admin_action"
      );
    }

    /* ---------- üü¢ MARK VISIBLE NOTIFICATIONS AS READ ---------- */
    async function markVisibleAsRead(user, notifications) {
      try {
        const isAdmin = user.email === ADMIN_EMAIL;

        for (const n of notifications) {
          const readBy = Array.isArray(n.readBy) ? n.readBy : [];
          if (!readBy.includes(user.uid)) {
            if (isAdmin) {
              if (n.type === "admin_action" || n.type === "approval_request" || !("userId" in n)) {
                await updateDoc(doc(db, "notifications", n.id), {
                  readBy: arrayUnion(user.uid),
                });
              }
            } else {
              if (!n.userId || n.userId === user.uid) {
                await updateDoc(doc(db, "notifications", n.id), {
                  readBy: arrayUnion(user.uid),
                });
              }
            }
          }
        }

        console.log("[notifications] ‚úÖ Synlige notifikationer markeret som l√¶st.");
        const cnt = document.getElementById("notif-count");
        const cntMobile = document.getElementById("notif-count-mobile");
        cnt?.classList.add("hidden");
        cntMobile?.classList.add("hidden");
      } catch (err) {
        console.error("‚ö†Ô∏è Fejl ved markering som l√¶st:", err);
      }
    }

    /* ---------- LOAD NOTIFICATIONS ---------- */
    async function loadNotifications(user) {
      try {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.exists() ? userSnap.data() : {};
        const isAdmin = user.email === ADMIN_EMAIL;

        const isVerified =
          isAdmin ||
          userData?.verifiedByAdmin === true ||
          userData?.status === "verified" ||
          userData?.role === "verified";

        if (!isVerified) {
          container.innerHTML = `<p class="text-red-500 text-center py-8">
            Du skal v√¶re godkendt af en administrator for at se notifikationer.
          </p>`;
          return;
        }

        const qy = query(collection(db, "notifications"), orderBy("timestamp", "desc"), limit(50));
        const snap = await getDocs(qy);

        if (snap.empty) {
          container.innerHTML = `<p class="text-gray-500 text-center py-8">Ingen notifikationer endnu.</p>`;
          return;
        }

        container.innerHTML = "";
        let pendingApprovals = 0;

        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          const id = docSnap.id;

          const isApproval = data.type === "approval_request";
          const isOwner = data.userId && data.userId === user.uid;

          // üîí Visibility logic (admins see global, approvals, and their own admin_action)
          if (isAdmin) {
            if (
              data.type !== "admin_action" &&
              data.type !== "approval_request" &&
              "userId" in data
            ) continue;
          } else {
            if (data.userId && data.userId !== user.uid) continue;
          }

          const time = data.timestamp
            ? new Date((data.timestamp.seconds || 0) * 1000).toLocaleString("da-DK")
            : "";

          const notif = document.createElement("div");
          notif.className = "border-b border-gray-200 py-3 last:border-none";

          let html = `
            <div class="font-bold text-yellow-700 text-lg mb-1">${data.title || "Ny Notifikation"}</div>
            <div class="text-gray-700 mb-1">${data.message || ""}</div>
            <div class="text-gray-500 text-sm">${time}</div>
          `;

          if (isAdmin && isApproval) {
            pendingApprovals++;
            html += `
              <div class="flex gap-3 mt-3">
                <button class="btn btn-approve" id="approve-${id}">Godkend</button>
                <button class="btn btn-deny" id="deny-${id}">Afvis</button>
              </div>
            `;
          }

          notif.innerHTML = html;
          container.appendChild(notif);

          if (isAdmin && isApproval) {
            document.getElementById(`approve-${id}`)?.addEventListener("click", async () => {
              await approveUser(data.userId);
              await deleteDoc(doc(db, "notifications", id));
              alert("‚úÖ Bruger godkendt!");
              await loadNotifications(user);
            });

            document.getElementById(`deny-${id}`)?.addEventListener("click", async () => {
              await denyUser(data.userId);
              await deleteDoc(doc(db, "notifications", id));
              alert("‚ùå Bruger afvist!");
              await loadNotifications(user);
            });
          }
        }

        console.log(`[notifications] ‚úÖ Indl√¶st (${pendingApprovals} godkendelser afventer).`);

        // ‚úÖ Mark visible as read
        await markVisibleAsRead(user, snap.docs.map(d => ({ id: d.id, ...d.data() })));

      } catch (err) {
        console.error("‚ùå Fejl ved indl√¶sning af notifikationer:", err);
        container.innerHTML = `<p class="text-red-500 text-center py-8">
          Fejl ved indl√¶sning af notifikationer.
        </p>`;
      }
    }

    /* ---------- INIT ---------- */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        container.innerHTML = `<p class="text-gray-500 text-center py-8">
          Log ind for at se notifikationer.
        </p>`;
        return;
      }
      await loadNotifications(user);
    });
  </script>
</body>
</html>
