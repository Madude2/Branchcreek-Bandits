<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifikationer - Branchcreek Bandits</title>

  <!-- Tailwind + Fonts + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.cdnfonts.com/css/western" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <style>
    .nav-link { color: white; }
    .nav-link:hover { color: #d4a017; }
    h1,h2,h3,h4,h5,h6 { font-family: 'Western', sans-serif; }
    .western-text { font-family: 'Western', sans-serif; }
    .btn-gold { background-color: #d4a017; transition: all 0.3s ease; }
    .btn-gold:hover { background-color: #b78a14; transform: translateY(-2px); }

    /* üßπ Prevent flicker: keep notification badge hidden until JS decides otherwise */
    #notif-count {
      display: none !important;
    }
    #notif-count.active {
      display: inline-flex !important;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans flex flex-col min-h-screen">

  <!-- Hide badge immediately (prevents flicker before JS loads) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const cnt = document.getElementById("notif-count");
      if (cnt) cnt.style.display = "none";
    });
  </script>

  <!-- Dynamic Navbar -->
  <div id="navbar"></div>

  <!-- Main Content -->
  <main class="flex-grow py-16">
    <div class="container mx-auto px-6">
      <h1 class="western-text text-5xl mb-6 text-center text-gray-900">Notifikationer</h1>
      <p class="text-gray-700 mb-10 text-center">
        Her kan du se de seneste opdateringer fra Branchcreek Bandits.
      </p>

      <div id="notifications-container" class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
        <p class="text-gray-500 text-center">Indl√¶ser notifikationer...</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Shared Firebase + Navbar logic -->
  <script type="module" src="main.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script type="module" src="js/common.js"></script>

  <!-- Page-specific Notification Logic -->
  <script type="module">
    import { getApps, initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, orderBy, limit, updateDoc, doc 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzk3xKdC0p9logWjGIZX41M1oeIeqjxGI",
      authDomain: "branchcreek-bandits.firebaseapp.com",
      projectId: "branchcreek-bandits",
      storageBucket: "branchcreek-bandits.firebasestorage.app",
      messagingSenderId: "828305260971",
      appId: "1:828305260971:web:6c3601fc97601a9621d2ee",
      measurementId: "G-550TRD5SQ3"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const container = document.getElementById("notifications-container");

    /* --- üßπ Hide bell + pause updates early --- */
    const cntEl = document.getElementById("notif-count");
    if (cntEl) {
      cntEl.textContent = "0";
      cntEl.classList.remove("active"); // keep hidden (no flicker)
      window._pauseNotifUpdates = true;
    }

    async function loadNotifications() {
      try {
        const qy = query(collection(db, "notifications"), orderBy("timestamp", "desc"), limit(20));
        const snap = await getDocs(qy);

        if (snap.empty) {
          container.innerHTML = `<p class="text-gray-500 text-center py-8">Ingen notifikationer endnu.</p>`;
          return;
        }

        container.innerHTML = "";
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const time = data.timestamp
            ? new Date(data.timestamp.seconds * 1000).toLocaleString("da-DK")
            : "";
          const notif = document.createElement("div");
          notif.className = "border-b border-gray-200 py-3 last:border-none";
          notif.innerHTML = `
            <div class="font-bold text-yellow-700 text-lg mb-1">${data.title || "Ny Notifikation"}</div>
            <div class="text-gray-700 mb-1">${data.message || ""}</div>
            <div class="text-gray-500 text-sm">${time}</div>
          `;
          container.appendChild(notif);
        });
      } catch (err) {
        console.error("‚ùå Fejl ved indl√¶sning af notifikationer:", err);
        container.innerHTML = `<p class="text-red-500 text-center py-8">Fejl ved indl√¶sning af notifikationer</p>`;
      }
    }

    async function markAllAsRead(user) {
      if (!user) return;
      try {
        const qy = query(collection(db, "notifications"), orderBy("timestamp", "desc"));
        const snap = await getDocs(qy);
        const updates = snap.docs.map(async (docSnap) => {
          const data = docSnap.data();
          const readBy = Array.isArray(data.readBy) ? data.readBy : [];
          if (!readBy.includes(user.uid)) {
            await updateDoc(doc(db, "notifications", docSnap.id), {
              readBy: [...readBy, user.uid]
            });
          }
        });
        await Promise.all(updates);
        console.log("‚úÖ Alle notifikationer markeret som l√¶st.");
      } catch (err) {
        console.error("‚ùå Fejl ved markering som l√¶st:", err);
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      await loadNotifications();

      // Wait for user to be logged in before marking as read
      onAuthStateChanged(auth, async (user) => {
        if (user && user.emailVerified) {
          await markAllAsRead(user);

          // Unpause after updates done (ensure no flicker)
          setTimeout(() => {
            window._pauseNotifUpdates = false;
          }, 2000);
        }
      });
    });
  </script>
</body>
</html>
