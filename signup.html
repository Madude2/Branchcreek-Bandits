<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Branchcreek Bandits - Opret Konto</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<link href="https://fonts.cdnfonts.com/css/western" rel="stylesheet">

<style>
/* ===== Base styling ===== */
h1,h2,h3,h4,h5,h6 { font-family: 'Western', sans-serif; }
input, button { border-radius: 0 !important; }
.btn-gold {
  background-color: #d4a017;
  transition: all 0.3s ease;
  color: rgb(0, 0, 0);
}
.btn-gold:hover {
  background-color: #b78a14;
  transform: translateY(-2px);
}
.btn-disabled {
  background-color: #9ca3af !important;
  cursor: not-allowed !important;
  transform: none !important;
}
a.back-home { display: inline-block; margin-top: 15px; color: #4285F4; text-decoration: underline; }

/* ===== âœ… Local font fix for logo and title ===== */
nav a span,
h1.western-text {
  font-family: 'Western', serif !important;
  letter-spacing: 0.05em;
}
</style>
</head>

<body class="bg-gray-100 font-sans">

<!-- Dynamic Navbar -->
<div id="navbar"></div>

<!-- Signup Section -->
<section class="py-20">
  <div class="container mx-auto px-6 max-w-lg bg-white shadow-lg p-8">
    <h1 class="text-3xl font-bold mb-6 text-center western-text">Opret Konto</h1>

    <div id="signup-form">
      <input type="text" id="signup-name" placeholder="Navn" class="w-full mb-3 px-3 py-2 border">
      <input type="email" id="signup-email" placeholder="Email" class="w-full mb-3 px-3 py-2 border">
      <input type="password" id="signup-password" placeholder="Password" class="w-full mb-3 px-3 py-2 border">
      <button onclick="signup()" class="w-full btn-gold py-2 font-bold mb-3">Opret Konto</button>
      
      <p class="text-center text-sm">Har du allerede en konto? 
        <a href="index.html" class="text-blue-600 hover:underline">Login her</a>
      </p>
    </div>

    <div id="signup-success" class="hidden text-center">
      <h2 class="text-2xl font-bold mb-3 western-text">Tillykke! Konto oprettet.</h2>
      <p>En bekrÃ¦ftelses-email er blevet sendt til din e-mail. Tak for at registrere dig!</p>
      <p>Hvis du ikke kan finde din mail, sÃ¥ tjek din spam mappe.</p>
      <a href="index.html" class="back-home">GÃ¥ tilbage til forsiden</a>
    </div>
  </div>
</section>

<!-- Dynamic Footer -->
<div id="footer"></div>

<!-- Feather icons + Nav/Footer Loader -->
<script>
feather.replace();
function includeHTML(file, elementId, callback){
  fetch(file)
    .then(res => res.text())
    .then(data => {
      document.getElementById(elementId).innerHTML = data;
      if(callback) callback();
      feather.replace();
    })
    .catch(err => console.error(err));
}
includeHTML("nav.html", "navbar");
includeHTML("footer.html", "footer");
</script>

<!-- Firebase Signup Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getAuth, createUserWithEmailAndPassword, updateProfile, sendEmailVerification, signOut 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { 
  getFirestore, doc, setDoc, addDoc, collection, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzk3xKdC0p9logWjGIZX41M1oeIeqjxGI",
  authDomain: "branchcreek-bandits.firebaseapp.com",
  projectId: "branchcreek-bandits",
  storageBucket: "branchcreek-bandits.appspot.com",
  messagingSenderId: "828305260971",
  appId: "1:828305260971:web:6c3601fc97601a9621d2ee",
  measurementId: "G-550TRD5SQ3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_EMAIL = "asbjrnahle33@gmail.com";

window.signup = async function() {
  const name = document.getElementById("signup-name").value.trim();
  const email = document.getElementById("signup-email").value.trim();
  const password = document.getElementById("signup-password").value;
  const btn = document.querySelector(".btn-gold");

  if (!name || !email || !password) {
    alert("Udfyld alle felter");
    return;
  }

  // ðŸŒ€ Disable button and show throbber
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.classList.add("btn-disabled");
  btn.innerHTML = `
    <span class="flex justify-center items-center gap-2">
      <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span>Opretter konto...</span>
    </span>
  `;

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const user = cred.user;
    const isAdmin = user.email === ADMIN_EMAIL;

    await setDoc(doc(db, "users", user.uid), {
      email: user.email,
      displayName: name,
      status: isAdmin ? "verified" : "registered",
      verifiedByAdmin: isAdmin,
      role: isAdmin ? "admin" : "registered",
      createdAt: serverTimestamp(),
      emailVerified: false,
    });

    if (!isAdmin) {
      await addDoc(collection(db, "notifications"), {
        title: "Ny bruger venter pÃ¥ godkendelse",
        message: `Bruger ${user.email} har oprettet en konto og venter pÃ¥ godkendelse.`,
        type: "approval_request",
        userId: user.uid,
        timestamp: serverTimestamp(),
        readBy: [],
      });
    }

    await sendEmailVerification(user);

    document.getElementById("signup-form").classList.add("hidden");
    document.getElementById("signup-success").classList.remove("hidden");

    await signOut(auth);
  } catch (err) {
    console.error("[signup.html] âŒ Signup error:", err);
    alert("Fejl ved oprettelse: " + err.message);
  } finally {
    btn.disabled = false;
    btn.classList.remove("btn-disabled");
    btn.innerHTML = originalHTML;
  }
};

/* âœ… Allow Enter key to submit form */
document.addEventListener("keypress", (e) => {
  if (e.key === "Enter" && document.activeElement.closest("#signup-form")) {
    e.preventDefault();
    signup();
  }
});
</script>

<!-- Shared scripts -->
<script type="module" src="js/firebase.js"></script>
<script type="module" src="js/auth.js"></script>
<script type="module" src="js/common.js"></script>

</body>
</html>
